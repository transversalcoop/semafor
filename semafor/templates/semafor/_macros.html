{% macro nav_link(request, title, link) %}
<li class="nav-item">
  <a class="nav-link {% if link_active(request, link) %}active{% endif %}" aria-current="page" href="{{ link }}">
    {{ title }}
  </a>
</li>
{% endmacro %}

{% macro workers_menu(request, workers) %}
<div class="navbar navbar-expand-md bd-navbar">
  <nav class="container-fluid d-flex justify-content-center" aria-label="Navegació secundària">
    <ul class="navbar-nav mb-2 mb-lg-0">
      {% for w in workers %}
      <li class="nav-item">
        {% set link = url("worker_forecast", args=[w.uuid]) %}
        <a class="nav-link {% if link_active(request, link, exact=True) %}active{% endif %}" aria-current="page" href="{{ link }}">
          {{ w.name }}
        </a>
      </li>
      {% endfor %}
    </ul>
  </nav>
</div>
{% endmacro %}

{% macro project_classes(project, year, month) %}{% if project.starts(year, month) %} project-starts{% endif %}{% if project.ends(year, month) %} project-ends{% endif %}{% endmacro %}

{% macro projects_table_head(title, time_span, el="th") %}
<tr>
  <th>{{ title }}</th>
  {% for year, month in time_span %}
  <{{ el }} class="text-center">{{ "%02d" % month }}/{{ year }}</{{ el }}>
  {% endfor %}
</tr>
{% endmacro %}

{% macro projects_table(projects, time_span, total_worked, total_dedication, worker=None, project_assignments=None, worker_dedications=None, id_prefix="total") %}
{% for project in projects %}
<tr>
  <th class="text-nowrap">{{ project }}</th>
  {% set totals, explanations = project.work_assignments(worker=worker) %}
  {% for year, month in time_span %}
    {% if worker %}
      {% set pa = project_assignments[project.uuid][(year, month)] %}
      {% if pa %}
      {% with object = pa, total_dedication = worker_dedications.get((year, month), {}).dedication %}{% include 'fragments/assignment.html' %}{% endwith %}
      {% else %}
        <td
          id="project-{{ project.uuid }}-worker-{{ worker.uuid }}-{{ year }}-{{ month }}"
          class="text-center {% if project.active(year, month) %}clickable{% endif %} {{ project_classes(project, year, month) }}"
          {% if project.active(year, month) %}
          hx-post="{{ url("create_project_assignment") }}"
          hx-vals='{"year": {{ year }}, "month": {{ month }}, "worker": "{{ worker.uuid }}", "project": "{{ project.uuid }}"}'
          hx-include="[name='csrfmiddlewaretoken']"
          hx-swap="outerHTML"
          {% endif %}
          ></td>
      {% endif %}
    {% else %}
      <td
        title="{% if total_dedication[(year, month)] %}{{ explanations[(year, month)] or "" }}{% else %}No hi ha cap treballador aquest mes!{% endif %}"
        class="text-center {{ dedication_intensity(totals[(year, month)], total_dedication[(year, month)]) }} {{ project_classes(project, year, month) }}"
      >
        {{ totals[(year, month)] or "" }}
      </td>
    {% endif %}
  {% endfor %}
</tr>
{% endfor %}
<tr class="border-top" hx-ext="ws" ws-connect="/ws/{% if worker %}worker/{{ worker.uuid }}{% else %}total{% endif %}/">
  <th class="fw-bold">Total</th>
  {% for year, month in time_span %}
    {% with total_worked=total_worked[(year, month)], total_dedication=total_dedication[(year, month)] %}{% include 'fragments/assignment_total.html' %}{% endwith %}
  {% endfor %}
</tr>
{% endmacro %}
